# Garfield-cli

The web infrastructure for building modern web applications.

## é¡¹ç›®ç¼˜èµ·

ç°åœ¨éƒ¨é—¨é¡¹ç›®ä¸»è¦ä½¿ç”¨ CRA æ„å»ºï¼Œä½†æ˜¯ CRA å­˜åœ¨ä¸€äº›é—®é¢˜ï¼š

- CRA ä¸å…·å¤‡å®šåˆ¶åŒ–èƒ½åŠ›ï¼Œä¸åƒ Vue-cli å¯ä»¥åœ¨åˆå§‹åŒ–çš„æ—¶å€™é€‰æ‹©éœ€è¦çš„ç‰¹æ€§ï¼Œå¯¼è‡´æ–°åˆ›å»ºçš„é¡¹ç›®éœ€è¦èŠ±å¤§é‡æ—¶é—´æ‰‹åŠ¨é…ç½®ã€‚è™½ç„¶ CRA å¯ä»¥ä½¿ç”¨è‡ªå®šä¹‰æ¨¡æ¿ï¼Œä½†æ˜¯è¿˜æ˜¯ä¸å¤Ÿçµæ´»ï¼›
- CRA ä¸èƒ½åƒ Vue-cli ä¸€æ ·ä¼ å…¥è‡ªå®šä¹‰ Webpack é…ç½®ã€‚è™½ç„¶å¯ä»¥é€šè¿‡ç¬¬ä¸‰æ–¹åº“è§£å†³ï¼Œä½†æ˜¯ç½‘ä¸Šèµ„æ–™æ¯”è¾ƒå°‘ï¼Œè€Œä¸”å¢åŠ å­¦ä¹ æˆæœ¬ï¼›

ç”±äºä»¥ä¸Šçš„åŸå› ï¼Œå¯¼è‡´åœ¨å¼€å‘æ–°é¡¹ç›®æ—¶ï¼Œå¾ˆå¤šåŒäº‹å®å¯ç›´æ¥å¤åˆ¶ä¸€ä»½å­˜é‡é¡¹ç›®ï¼Œä¹Ÿä¸æ„¿æ„ä»é›¶å¼€å§‹é…ç½®ã€‚æœ¬é¡¹ç›®æ—¨åœ¨å­¦ä¹ ç ”ç©¶ CRA æºç çš„åŸºç¡€ä¸Šï¼Œé€šè¿‡å¼€å‘ä¸€å¥—è„šæ‰‹æ¶æ„å»ºå·¥å…·ï¼Œè§£å†³ CRA å­˜åœ¨çš„é—®é¢˜ã€‚

é€šè¿‡ç ”ç©¶ CRA æºç å¯çŸ¥ï¼Œä¸€ä¸ªå‰ç«¯é¡¹ç›®å¯ä»¥åˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼š

- é¡¹ç›®æ¨¡æ¿ï¼šé¡¹ç›®æ ¹ç›®å½•ä¸‹çš„å†…å®¹ï¼Œä¹Ÿå°±æ˜¯ä¸ä¸šåŠ¡å¼€å‘æœ‰äº¤é›†çš„éƒ¨åˆ†ï¼›
- æ„å»ºè„šæœ¬ï¼šé€šå¸¸å®‰è£…åœ¨ `node_modules` é‡Œé¢ï¼Œåªåœ¨æ„å»ºæ—¶å‘æŒ¥ä½œç”¨ï¼Œä¸€èˆ¬å¾ˆå°‘å»æ”¹åŠ¨ï¼›

å› æ­¤å¯ä»¥é€šè¿‡ monorepo æœºåˆ¶ç®¡ç†å¤šä¸ªåŒ…ï¼Œä¾‹å¦‚ï¼š

```js
// é¡¹ç›®æ¨¡æ¿
react-template
react-ts-template
vue-template
vue-ts-template

// æ„å»ºè„šæœ¬
garfield-script

// é¡¹ç›®é…ç½®
garfield-redux
garfield-router
eslint-config
prettier-config
commit-lint
```

å¦‚æœä½¿ç”¨è‡ªå®šä¹‰çš„è„šæ‰‹æ¶å·¥å…·ï¼Œä¸ä»…å¯ä»¥æ”¯æŒè‡ªå®šä¹‰ Webpack é…ç½®ï¼Œè¿˜å¯ä»¥å¢åŠ ä¸åŒçš„é¡¹ç›®æ¨¡æ¿ï¼ŒåŒæ—¶æ”¯æŒ React å’Œ Vue é¡¹ç›®ï¼Œæ­¤å¤–è¿˜æä¾›å¼€ç®±å³ç”¨çš„é…ç½®ï¼Œä¾‹å¦‚ React çŠ¶æ€ç®¡ç†åº“ä¸ä»…é…ç½®éº»çƒ¦ï¼Œä½¿ç”¨ä¹Ÿå¾ˆéº»çƒ¦ï¼Œæ‰€ä»¥å¹²è„†å°è£…æˆäº†ä¸€ä¸ªä¾èµ–åº“ï¼Œæ”¯æŒçƒ­æ’æ‹”ï¼Œä¸€ä¸ªå‘½ä»¤å³å¯ä¸ºé¡¹ç›®èµ‹èƒ½ã€‚

## é¡¹ç›®ç‰¹ç‚¹

- ä½¿ç”¨å•ä»“å¤šåŒ…ï¼ˆmonorepoï¼‰ï¼Œæ”¯æŒçƒ­æ’æ‹”ï¼Œä¸€ä¸ªå‘½ä»¤å³å¯ä¸ºé¡¹ç›®èµ‹èƒ½ï¼›
- ä½¿ç”¨ pre-script è¿›è¡Œå‰ç½®æ“ä½œï¼Œä¾‹å¦‚æ£€æŸ¥ç‰ˆæœ¬ã€æ‰“å°æ¬¢è¿ä¿¡æ¯ï¼›
- å› ä¸ºæ˜¯æ„å»ºå·¥å…·ï¼Œæ‰€ä»¥åªç”¨ä¸€ä»½ `webpack.config.js` ï¼Œå…·ä½“å‚è€ƒ CRA é…ç½®ï¼›
- å‚è€ƒ Vue-cli åšæ³•ï¼Œä½¿ç”¨ `chain-webpack` çš„æ–¹å¼è¿›è¡Œé…ç½®ï¼›
- ä½¿ç”¨ CRA ä¸­çš„å·¥å…·å‡½æ•°ï¼Œä¾‹å¦‚è·å–å·¥ä½œç›®å½•ã€æ¸…ç©ºæ§åˆ¶å°ç­‰ç­‰ï¼›
- å‚è€ƒ Vue-cli åšæ³•ï¼Œå…è®¸æä¾›è‡ªå®šä¹‰é…ç½®æ–‡ä»¶ä¸é»˜è®¤é…ç½®æ–‡ä»¶åˆå¹¶ï¼›

## æŠ€æœ¯ç»†èŠ‚

ä½¿ç”¨ Webpack5 ï¼Œå¼€å‘æœåŠ¡å™¨ä½¿ç”¨ `express` + `webpack-dev-middleware`

ç°åœ¨å®ç°å•ä»“å¤šåŒ…æ–¹æ¡ˆä¸»è¦æœ‰ï¼š

- lerna + yarn workspace ï¼›
- pnpm ï¼›

> å…¶ä¸­ pnpm è‡ªå¸¦å•ä»“å¤šåŒ…åŠŸèƒ½ï¼Œä¸ä¼šå‡ºç°ä¾èµ–é‡å¤å®‰è£…é—®é¢˜ï¼Œè€Œä¸”è§£å†³äº†å¹½çµä¾èµ–é—®é¢˜ï¼ŒVue3 å’Œ Vite éƒ½åœ¨ä½¿ç”¨ã€‚

ä½¿ç”¨ npm ç§æœ

ä½¿ç”¨æ„å»ºå‘å¸ƒè„šæœ¬ï¼Œé€šè¿‡ `npm run release` å‘å¸ƒ npm åŒ…ï¼š

- æ‰§è¡Œæ„å»ºå‘½ä»¤ï¼Œå°†æ„å»ºäº§ç‰©è¾“å‡ºåˆ° `./dist` ç›®å½•ï¼›
- è·å–æ­£ç¡®çš„ç‰ˆæœ¬å·ï¼Œå¹¶ä¿®æ”¹ `package.json` ï¼›
- å°† `package.json` å’Œ `README.md` å¤åˆ¶åˆ° `./dist` ç›®å½•ï¼›
- æœ€åæ‰§è¡Œ `npm publish` å‘å¸ƒï¼›

> å‚è€ƒï¼š
> 
> [æ‰‹æŠŠæ‰‹æ•™ä½ ä½¿ç”¨Rollupæ‰“åŒ…ğŸ“¦å¹¶å‘å¸ƒè‡ªå·±çš„å·¥å…·åº“ğŸ”§](https://juejin.cn/post/6902659492161421325)
>
> [å¤§å‚æ˜¯å¦‚ä½•ç”¨DevCloudæµæ°´çº¿å®ç°è‡ªåŠ¨åŒ–éƒ¨ç½²Webåº”ç”¨çš„ï¼Ÿ](https://juejin.cn/post/6887961766170066951)

æ’ä»¶å‡çº§æ–¹æ¡ˆï¼š

- é™æ€èµ„æºå¤„ç†ï¼Œå›¾ç‰‡ã€å­—ä½“æ‰“åŒ…ï¼š`url-loader` -> Webpack5 å†…ç½® Asset Modulesï¼›
- æ¸…ç†ç›®å½•æ’ä»¶ï¼š`clean-webpack-plugin` -> Webpack5 å†…ç½® `output.clean` é…ç½®é¡¹ï¼›
- ä»£ç å‹ç¼©æ’ä»¶ï¼š`uglify-js-webpack-plugin` -> Webpack5 å†…ç½® `terser-webpack-plugin` (ç”Ÿäº§ç¯å¢ƒä¸‹ä½¿ç”¨ï¼Œç§»é™¤ä»£ç ä¸­çš„ `debugger` å’Œ `console.*`) ï¼›
- æŠ½å–å…¬å…±æ¨¡å—ï¼š`CommonChunksPlugin` -> Webpack5 å†…ç½® `optimization.splitChunks` ï¼›
- æŠ½å– CSS æ’ä»¶ï¼š`extract-text-webpack-plugin` -> `mini-css-extract-plugin` (ç”Ÿäº§ç¯å¢ƒä¸‹ä½¿ç”¨ï¼Œå¼€å‘ç¯å¢ƒä¸‹ä¸ºäº†è®©æ ·å¼æºæ–‡ä»¶ä¹Ÿèƒ½è¢«çƒ­æ›¿æ¢ï¼Œä¸èƒ½æŠ½å–æ ·å¼ï¼Œè€Œæ˜¯éš JS Bundle ä¸€èµ·è¾“å‡º) ï¼›
- å‹ç¼© CSS æ’ä»¶ï¼š`optimize-css-assets-webpack-plugin` -> `css-minimizer-webpack-plugin` (ç”Ÿäº§ç¯å¢ƒä¸‹ä½¿ç”¨) ï¼›
- å…¶ä»–æ’ä»¶ä¾‹å¦‚ `html-webpack-plugin` è™½ç„¶ä¸ç”¨æ¢ï¼Œä½†ä¹Ÿéœ€è¦å‡çº§åˆ°æ”¯æŒ Webpack5 çš„ç‰ˆæœ¬ï¼›

ä¼˜åŒ–æ–¹æ¡ˆï¼š

- åŒºåˆ†å¼€å‘ç¯å¢ƒå’Œç”Ÿäº§ç¯å¢ƒï¼›
- ç¯å¢ƒå˜é‡é»˜è®¤æ”¯æŒä¸‰ä¸ªç¯å¢ƒï¼š
  - development: å¼€å‘ç¯å¢ƒï¼›
  - staging: é¢„å‘å¸ƒç¯å¢ƒï¼›
  - production: ç”Ÿäº§ç¯å¢ƒï¼›
- å¼€å¯ sourceMap: 
  - å¼€å‘ç¯å¢ƒä½¿ç”¨ `eval-cheap-module-source-map` ï¼›
  - ç”Ÿäº§ç¯å¢ƒä¸å¼€å¯æˆ–è€…ä½¿ç”¨ `hidden-source-map` ï¼›
- å¯ç”¨ CSSã€lessã€sass æ¨¡å—åŒ–ï¼›
- Webpack è¿è¡Œæ—¶ä»£ç å•ç‹¬æ‰“åŒ…ï¼ˆWebpack5 æ–°ç‰¹æ€§ï¼Œè¯¦è§ [Webpack Chunk åˆ†åŒ…è§„åˆ™](https://juejin.cn/post/6961724298243342344)ï¼‰ï¼Œå•ç‹¬æ‰“åŒ…ä¸æ˜¯ç›®çš„ï¼Œä¸»è¦æ˜¯ä¸ºäº†è®¾ç½®ç¼“å­˜ã€‚è¿™å—ä»£ç åŸºæœ¬ä¸Šä¸ä¼šä¿®æ”¹ï¼Œå¦‚æœè¿˜è·Ÿä¸šåŠ¡ä»£ç ä¸€èµ·æ‰“åŒ…è¿›å»ï¼Œé‚£ä¹ˆæ¯æ¬¡ä¸šåŠ¡ä»£ç ä¿®æ”¹ï¼Œæµè§ˆå™¨è¿˜å¾—åŠ è½½ä¸€é webapck runtime çš„ä»£ç ï¼Œæµªè´¹å¸¦å®½ï¼š

  ```js
  module.exports = {
    entry: {
      index: { import: "./src/index", runtime: "solid-runtime" },
    }
  };
  ```

- å¼€å¯æ¨¡å—æ„å»ºç¼“å­˜ï¼Œæ˜¾è‘—æå‡æ„å»ºé€Ÿåº¦:

  ```js
  module.exports = {
    cache: {
      type: 'filesystem',
      buildDependencies: {
        config: [__filename]
      }
    },
  };
  ```

  > æ¨èåœ¨ webpack é…ç½®ä¸­è®¾ç½® `cache.buildDependencies.config: [__filename]` æ¥è·å–æœ€æ–°é…ç½®ä»¥åŠæ‰€æœ‰ä¾èµ–é¡¹
  > 
  > å‚è€ƒï¼šhttps://webpack.docschina.org/configuration/cache/#root

- å¯åŠ¨ Tree Shaking åŠŸèƒ½ï¼š
  
  åœ¨ Webpack ä¸­ï¼Œå¯åŠ¨ Tree Shaking åŠŸèƒ½å¿…é¡»åŒæ—¶æ»¡è¶³ä¸‰ä¸ªæ¡ä»¶ï¼š
  - ä½¿ç”¨ ESM è§„èŒƒç¼–å†™æ¨¡å—ä»£ç 
  - é…ç½® `optimization.usedExports` ä¸º `true` ï¼Œå¯åŠ¨æ ‡è®°åŠŸèƒ½
  - å¯åŠ¨ä»£ç ä¼˜åŒ–åŠŸèƒ½ï¼ˆç›®çš„æ˜¯å¯ç”¨ä»£ç å‹ç¼©ï¼Œä½¿ç”¨ Terser åˆ æ‰æ²¡ç”¨åˆ°çš„å¯¼å‡ºè¯­å¥ï¼‰ï¼Œå¯ä»¥é€šè¿‡å¦‚ä¸‹æ–¹å¼å®ç°ï¼š

    ```js
    // é…ç½® mode = production
    mode: "production"
    // æˆ–è€…é…ç½®
    optimization.minimize = true
    // æˆ–è€…æä¾›æ•°ç»„
    optimization.minimizer = []
    ```

  > å‚è€ƒï¼šhttps://webpack.docschina.org/guides/tree-shaking/

- å¼€å‘ç¯å¢ƒå¯ç”¨çƒ­æ›´æ–°ï¼Œä½¿ç”¨ `react-refresh-webpack-plugin` çƒ­æ›´æ–° react ç»„ä»¶:

  å®‰è£…:

  ```bash
  $ npm install -D @pmmmwh/react-refresh-webpack-plugin react-refresh
  ```

  `webpack.dev.config.js` é…ç½®å¦‚ä¸‹:

  ```js
  const ReactRefreshWebpackPlugin = require('@pmmmwh/react-refresh-webpack-plugin');

  module.exports = {
    plugins: [
      new webpack.HotModuleReplacementPlugin(),
      new ReactRefreshWebpackPlugin(),
    ]
  }
  ```

  > å‚è€ƒï¼š[2021 å¹´ TypeScript + React å·¥ç¨‹åŒ–æŒ‡å—](https://zhuanlan.zhihu.com/p/403970666)

